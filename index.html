<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸ç¦ä¹…ä¹…ï¼ˆå°Šäº«ç‰ˆï¼‰ç»ˆèº«å¯¿é™©ï¼ˆåˆ†çº¢å‹ï¼‰åˆ©ç›Šæ¼”ç¤ºè¡¨</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>window.injectInfo = { env: "PROD" };</script>
    <script>window.publicPath = "https://gw.alipayobjects.com/render/p/yuyan/180023180006000310/";</script>
    <script defer src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å ä½ç¬¦è¡Œæ ·å¼ */
        /* å ä½ç¬¦è¡Œæ ·å¼ */
        .placeholder-row {
            background-color: #f9f9f9 !important;
            color: #999 !important;
            font-style: italic !important;
        }

        /* è¡¨æ ¼å®¹å™¨ */
        .table-container {
            max-height: 600px;
            overflow: auto;
            border: 1px solid #ddd;
            margin-top: 10px;
            position: relative;
        }

        /* è¡¨æ ¼ */
        .result-table {
            border-collapse: collapse;
            table-layout: fixed;
            width: 100%;
            min-width: 800px;
        }

        /* å†»ç»“è¡¨å¤´ */
        .result-table thead th {
            position: sticky;
            top: 0;
            z-index: 20;
            background: #f8f9fa;
            border-bottom: 2px solid #ddd;
            font-weight: 600;
        }

        /* å†»ç»“ç¬¬ä¸€åˆ— */
        .result-table th:first-child,
        .result-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 15;
            background: #f8f9fa;
            border-right: 2px solid #ddd;
        }

        /* å·¦ä¸Šè§’å•å…ƒæ ¼ç‰¹æ®Šå¤„ç† - åŒæ—¶å†»ç»“è¡Œå’Œåˆ— */
        .result-table thead th:first-child {
            z-index: 25;
            left: 0;
            background: #e9ecef;
        }

        /* åŸºæœ¬æ ·å¼ */
        .result-table th, .result-table td {
            padding: 8px 12px;
            border: 1px solid #ddd;
            text-align: right;
            white-space: nowrap;
            font-size: 12px;
            min-width: 60px;
        }

        .result-table th:first-child,
        .result-table td:first-child {
            text-align: center;
            min-width: 40px;
        }

        .result-table th:nth-child(2),
        .result-table td:nth-child(2) {
            text-align: center;
            min-width: 40px;
        }

        .result-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .result-table tbody tr:hover {
            background-color: #f0f7ff;
        }

        /* ç¡®ä¿å†»ç»“åˆ—åœ¨æ‚¬æµ®æ—¶ä¹Ÿæœ‰èƒŒæ™¯è‰² */
        .result-table tbody tr:hover td:first-child {
            background-color: #e6f3ff;
        }

        /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
        .result-table {
            width: 100%;
            border-collapse: collapse;
        }

        body {
            background-color: #f8f9fa;
        }
        .container {
            margin: 0;
            padding: 16px;
            border-radius: 8px;
        }
        .premium-button {
            transition: all 0.2s ease;
        }
        .premium-button:hover {
            transform: scale(1.05);
        }
        .premium-button.active {
            background-color: #3b82f6;
            color: white;
        }
        .payment-button {
            transition: all 0.2s ease;
        }
        .payment-button:hover {
            transform: scale(1.05);
        }
        .payment-button.active {
            background-color: #10b981;
            color: white;
        }
        .gender-button {
            transition: all 0.2s ease;
        }
        .gender-button:hover {
            transform: scale(1.05);
        }
        .gender-button.active {
            background-color: #8b5cf6;
            color: white;
        }
        input[type="range"] {
            --track-color: rgba(0,0,0,0.1);
        }
        input[type="range"]::-webkit-slider-thumb {
            background-color: #3b82f6;
        }
        input[type="range"]::-moz-range-thumb {
            background-color: #3b82f6;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .data-source {
            color: #22c55e;
            margin-top: 10px;
            font-size: 12px;
            text-align: right;
        }
        /* åˆ†äº«æ¨¡æ€æ¡†æ ·å¼ */
        #shareModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .share-modal-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .share-url-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-right: none;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
        }
        .copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }
        .copy-btn:hover {
            background: #2563eb;
        }
        .qrcode-container {
            width: 150px;
            height: 150px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            border-radius: 4px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .modal-btn.primary {
            background: #10b981;
            color: white;
        }
        .modal-btn.secondary {
            background: #6b7280;
            color: white;
        }
        .modal-btn:hover {
            opacity: 0.9;
        }
        /* ä¿®æ”¹æ ‡é¢˜æ ·å¼ä¸ºä¸¤è¡Œå±…ä¸­ */
        .page-title {
            text-align: center;
            line-height: 1.3;
            margin-bottom: 20px;
        }
        .title-line-1 {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            display: block;
        }
        .title-line-2 {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            display: block;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div id="container" class="container bg-white rounded-lg shadow-lg w-full" style="margin: 0px !important;">
        <div class="p-4">
            <!-- ä¿®æ”¹æ ‡é¢˜ä¸ºä¸¤è¡Œå±…ä¸­ -->
            <h1 class="page-title">
                <span class="title-line-1">å¹¸ç¦ä¹…ä¹…ï¼ˆå°Šäº«ç‰ˆï¼‰ç»ˆèº«å¯¿é™©ï¼ˆåˆ†çº¢å‹ï¼‰</span>
                <span class="title-line-2">åˆ©ç›Šæ¼”ç¤ºè¡¨</span>
            </h1>
            
            <!-- æ€§åˆ«é€‰æ‹© -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="material-icons text-sm mr-1">wc</span>æ€§åˆ«
                </label>
                <div class="grid grid-cols-2 gap-2">
                    <label class="gender-button flex items-center justify-center py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-all cursor-pointer" data-gender="male" data-testid="gender-male">
                        <input type="radio" name="gender" value="male" class="hidden">
                        <span class="material-icons text-sm mr-1">man</span>ç”·
                    </label>
                    <label class="gender-button flex items-center justify-center py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-all cursor-pointer active" data-gender="female" data-testid="gender-female">
                        <input type="radio" name="gender" value="female" class="hidden" checked>
                        <span class="material-icons text-sm mr-1">woman</span>å¥³
                    </label>
                </div>
            </div>

            <!-- æŠ•ä¿å¹´é¾„ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="material-icons text-sm mr-1">person</span>æŠ•ä¿å¹´é¾„
                </label>
                <div class="flex items-center space-x-2">
                    <input type="range" id="age" min="0" max="80" value="50" class="flex-1" data-testid="age-slider">
                    <span id="ageValue" class="text-sm font-medium w-12 text-center">50å²</span>
                </div>
            </div>

            <!-- äº¤è´¹æœŸé—´ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="material-icons text-sm mr-1">schedule</span>äº¤è´¹æœŸé—´
                </label>
                <div class="grid grid-cols-4 gap-2">
                    <button class="payment-button py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-all" data-payment="3" data-testid="payment-3">
                        3å¹´
                    </button>
                    <button class="payment-button py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-all" data-payment="4" data-testid="payment-4">
                        4å¹´
                    </button>
                    <button class="payment-button py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-all active" data-payment="5" data-testid="payment-5">
                        5å¹´
                    </button>
                    <button class="payment-button py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-all" data-payment="10" data-testid="payment-10">
                        10å¹´
                    </button>
                </div>
            </div>

            <!-- å¹´äº¤ä¿è´¹ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <span class="material-icons text-sm mr-1">payments</span>å¹´äº¤ä¿è´¹
                </label>
                
                <!-- å¿«é€Ÿé€‰æ‹©æŒ‰é’® -->
                <div class="grid grid-cols-4 gap-2 mb-3">
                    <button class="premium-button py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-all" data-premium="10000" data-testid="premium-10000">
                        1ä¸‡å…ƒ
                    </button>
                    <button class="premium-button py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-all" data-premium="50000" data-testid="premium-50000">
                        5ä¸‡å…ƒ
                    </button>
                    <button class="premium-button py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-all active" data-premium="100000" data-testid="premium-100000">
                        10ä¸‡å…ƒ
                    </button>
                    <button class="premium-button py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-all" data-premium="1000000" data-testid="premium-1000000">
                        100ä¸‡å…ƒ
                    </button>
                </div>
                
                <!-- è‡ªå®šä¹‰è¾“å…¥æ¡† -->
                <div class="flex items-center space-x-2">
                    <input type="number" id="customPremium" placeholder="è‡ªå®šä¹‰å¹´äº¤ä¿è´¹" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" data-testid="custom-premium">
                    <span class="text-sm text-gray-600">å…ƒ</span>
                </div>
            </div>

            <!-- è®¡ç®—æŒ‰é’® -->
            <div class="mb-6">
                <button id="calculateBtn" class="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition-colors" data-testid="calculate-btn">
                    <span class="material-icons text-sm mr-1">calculate</span>è®¡ç®—åˆ©ç›Š
                </button>
            </div>

            <!-- åŠ è½½åŠ¨ç”» -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p class="text-gray-600 mt-2">æ­£åœ¨åŠ è½½çœŸå®æ•°æ®ï¼Œè¯·å‹¿åˆ·æ–°...</p>
            </div>

            <!-- è®¡ç®—ç»“æœ -->
            <div id="resultSection" class="hidden">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800">å¹´åº¦åˆ©ç›Šæ˜ç»†</h2>
                    <span class="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded">å•ä½ï¼šå…ƒ</span>
                </div>
    
                <div class="mb-3 flex gap-2">
                    <button id="exportBtn" class="flex-1 bg-green-500 text-white py-2 px-3 rounded-lg text-sm font-mediumbg-green-600 transition-colors">
                        <span class="material-icons text-sm mr-1">download</span>å¯¼å‡ºExcel
                    </button>
                    <button id="shareBtn" class="flex-1 bg-green-600 text-white py-2 px-3 rounded-lg text-sm font-medium hover:bg-green-700 transition-colors">
                        <span class="material-icons text-sm mr-1">share</span>å¾®ä¿¡åˆ†äº«
                    </button>
                </div>
    
                <div class="table-container">
                    <table class="result-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;">å¹´åº¦</th>
                                <th style="width: 30px;">å¹´é¾„</th>
                                <th style="width: 60px;">å¹´åº¦ä¿è´¹</th>
                                <th style="width: 60px;">ç´¯è®¡ä¿è´¹</th>
                                <th style="width: 60px;">ç°é‡‘ä»·å€¼</th>
                                <th style="width: 60px;">ç´¯è®¡çº¢åˆ©</th>
                                <th style="width: 60px;">ç”Ÿå­˜æ€»åˆ©ç›Š</th>
                                <th style="width: 50px;">å½“å¹´æ”¶ç›Šç‡</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody">
                            <!-- æ•°æ®å°†ç”±JavaScriptå¡«å…… -->
                        </tbody>
                    </table>
                </div>
                <div class="data-source">âœ… æ•°æ®æ¥æºï¼šå…¨å¹´é¾„æ®µåˆå¹¶æ•°æ®.json</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡ï¼šå­˜å‚¨çœŸå®JSONæ•°æ®
        let insuranceDatabase = null;

        // 1. åŠ è½½çœŸå®JSONæ•°æ®
        async function loadInsuranceData() {
            try {
                console.log("å¼€å§‹åŠ è½½çœŸå®æ•°æ®...");
                const response = await fetch('index_files/å…¨å¹´é¾„æ®µåˆå¹¶æ•°æ®.json');
                
                if (!response.ok) {
                    throw new Error(`æ•°æ®æ–‡ä»¶æœªæ‰¾åˆ°ï¼è¯·æ£€æŸ¥"index_files"æ–‡ä»¶å¤¹æ˜¯å¦ä¸HTMLåŒçº§ï¼ŒçŠ¶æ€ç : ${response.status}`);
                }
                
                insuranceDatabase = await response.json();
                console.log("âœ… çœŸå®æ•°æ®åŠ è½½æˆåŠŸï¼åŒ…å«å¹´é¾„èŠ‚ç‚¹ï¼š", Object.keys(insuranceDatabase).join(", "));
                
                return insuranceDatabase;
            } catch (error) {
                console.error("âŒ æ•°æ®åŠ è½½å¤±è´¥ï¼š", error.message);
                alert("çœŸå®æ•°æ®åŠ è½½å¤±è´¥ï¼é”™è¯¯ï¼š" + error.message + "\nè¯·æ£€æŸ¥JSONæ–‡ä»¶è·¯å¾„å’Œæ ¼å¼");
                return null;
            }
        }

        // 2. ä¿é™©æ•°æ®è®¡ç®—å™¨
        class InsuranceCalculator {
            constructor() {
                this.realData = null;
            }

            // ä½¿ç”¨çœŸå®æ•°æ®è®¡ç®—
            calculateFromRealData(age, paymentYears, annualPremium, totalYears = 50) {
                // æ£€æŸ¥æ•°æ®æ˜¯å¦åŠ è½½å®Œæˆ
                if (!insuranceDatabase) {
                    alert("çœŸå®æ•°æ®æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                    return [];
                }

                // æŸ¥æ‰¾å½“å‰å¹´é¾„çš„çœŸå®æ•°æ®
                const genderChinese = currentGender === 'female' ? 'å¥³' : 'ç”·';
                const ageKey = `${genderChinese}_${age}`;
                console.log(`ğŸ” æŸ¥æ‰¾æ•°æ®é”®: ${ageKey}`);
                if (!insuranceDatabase[ageKey]) {
                    // æ˜¾ç¤ºå¯ç”¨çš„é”®ä»¥ä¾¿è°ƒè¯•
                    const availableKeys = Object.keys(insuranceDatabase);
                    const availableAges = availableKeys
                        .filter(key => key.startsWith(genderChinese))
                        .map(key => key.replace(`${genderChinese}_`, ''))
                        .sort((a, b) => a - b);

                    alert(`æœªæ‰¾åˆ°${ageKey}å²çš„çœŸå®æ•°æ®ï¼å½“å‰${genderChinese}æ€§æ”¯æŒå¹´é¾„ï¼š${availableAges.join(", ")}å²`);
                    return [];
                }
                const ageData = insuranceDatabase[ageKey];
                const benefitData = ageData.benefit_data || [];

                console.log(`ğŸ“Š æ‰¾åˆ°æ•°æ®ï¼š${benefitData.length}è¡Œ`);

                // ç”Ÿæˆ50å¹´çš„å®Œæ•´æ•°æ®
                const fullData = [];
                for (let year = 1; year <= 50; year++) {
                        const existingRow = benefitData.find(row => row.ä¿å•å¹´åº¦ === year);
        
                        if (existingRow) {
                            // ä½¿ç”¨çœŸå®æ•°æ®
                            fullData.push({
                                ä¿å•å¹´åº¦: existingRow.ä¿å•å¹´åº¦,
                                å¹´æœ«å¹´é¾„: existingRow.å¹´æœ«å¹´é¾„,
                                å¹´åº¦ä¿è´¹: existingRow.å¹´åº¦ä¿è´¹,
                                ç´¯è®¡ä¿è´¹: existingRow.ç´¯è®¡ä¿è´¹,
                                ç°é‡‘ä»·å€¼: existingRow.ç°é‡‘ä»·å€¼,
                                ç´¯è®¡çº¢åˆ©: existingRow.ç´¯è®¡çº¢åˆ©
                            });
                        } else {
                            // ç”Ÿæˆå ä½ç¬¦æ•°æ®ï¼ˆç”¨"-"è¡¨ç¤ºï¼‰
                            fullData.push({
                                ä¿å•å¹´åº¦: year,
                                å¹´æœ«å¹´é¾„: parseInt(age) + year,
                                å¹´åº¦ä¿è´¹: "-",
                                ç´¯è®¡ä¿è´¹: "-", 
                                ç°é‡‘ä»·å€¼: "-",
                                ç´¯è®¡çº¢åˆ©: "-"
                            });
                        }
                    }

                // æ£€æŸ¥äº¤è´¹æœŸé—´æ˜¯å¦åŒ¹é…ï¼ˆåªæ”¯æŒ5å¹´äº¤ï¼‰
                if (paymentYears !== 5) {
                    alert("æœªæŸ¥æ‰¾åˆ°æ•°æ®ï¼Œè¯·é‡æ–°è¾“å…¥å‚æ•°\nç›®å‰åªæ”¯æŒ5å¹´äº¤è´¹æœŸé—´çš„æ•°æ®");
                    return [];
                }

                // è®¡ç®—ä¿è´¹æ¯”ä¾‹ï¼ˆåŸºäºJSONä¸­çš„åŸºå‡†ä¿è´¹ï¼š10000å…ƒï¼‰
                const basePremium = ageData.å¹´äº¤ä¿è´¹ || 10000;
                const premiumRatio = annualPremium / basePremium;
                console.log(`ä¿è´¹æ¯”ä¾‹è®¡ç®—ï¼šè¾“å…¥ä¿è´¹${annualPremium}å…ƒ / åŸºå‡†ä¿è´¹${basePremium}å…ƒ = ${premiumRatio.toFixed(4)}`);

                // æå–å¹´åº¦çœŸå®æ•°æ®å¹¶æ•´ç†
                const results = [];
                let accumulatedPremium = 0;
                let prevTotalBenefit = 0; // ç”¨äºè®¡ç®—æ”¶ç›Šç‡

                for (let year = 1; year <= totalYears; year++) {
                    const currentAge = age + year - 1;
                    // è®¡ç®—ç´¯è®¡ä¿è´¹ï¼ˆä»…äº¤è´¹æœŸå†…ç´¯åŠ ï¼‰
                    const yearPremium = year <= paymentYears ? annualPremium : 0;
                    accumulatedPremium += yearPremium;

                    // ä»JSONä¸­æ‰¾åˆ°å¯¹åº”å¹´åº¦çš„æ•°æ®
                    const realYearData = ageData.benefit_data.find(item => item.ä¿å•å¹´åº¦ === year);
                    if (!realYearData) {
                        console.log(`ç¬¬${year}å¹´æ•°æ®ç¼ºå¤±ï¼Œè·³è¿‡è¯¥å¹´åº¦`);
                        break; // å¦‚æœæŸä¸€å¹´æ•°æ®ç¼ºå¤±ï¼Œåœæ­¢æå–åç»­æ•°æ®
                    }

                    // æŒ‰ä¿è´¹æ¯”ä¾‹è°ƒæ•´æ•°æ®å¹¶å–æ•´
                    const cashValue = Math.round(realYearData.ç°é‡‘ä»·å€¼ * premiumRatio);
                    const accumulatedBonus = Math.round(realYearData.ç´¯è®¡çº¢åˆ© * premiumRatio);
                    
                    // è®¡ç®—ç”Ÿå­˜æ€»åˆ©ç›Š = ç°é‡‘ä»·å€¼ + ç´¯è®¡çº¢åˆ©
                    const totalBenefit = Math.round(cashValue + accumulatedBonus);

                    // è®¡ç®—å½“å¹´æ”¶ç›Šç‡
                    let yieldRate = "-";
                    if (year >= 6) { // ä»ç¬¬2å¹´å¼€å§‹å°±å¯ä»¥è®¡ç®—æ”¶ç›Šç‡
                        // è·å–ä¸Šä¸€å¹´çš„æ•°æ®
                        const prevYearData = results[year - 2]; // å› ä¸ºæ•°ç»„ç´¢å¼•ä»0å¼€å§‹ï¼Œyear-2å¯¹åº”ä¸Šä¸€å¹´
    
                        if (prevYearData && prevYearData.totalBenefit !== "-") {
                            const currentTotalBenefit = totalBenefit;
                            const prevTotalBenefit = prevYearData.totalBenefit;
        
                            // è®¡ç®—ç´¯è®¡ä¿è´¹ = å¹´äº¤ä¿è´¹ Ã— äº¤è´¹æœŸé—´
                            const totalAccumulatedPremium = annualPremium * paymentYears;
        
                            // è®¡ç®—å…¬å¼ï¼šå½“å¹´æ”¶ç›Šç‡ = (å½“å¹´ç”Ÿå­˜æ€»åˆ©ç›Š - ä¸Šå¹´ç”Ÿå­˜æ€»åˆ©ç›Š) / ç´¯è®¡ä¿è´¹ Ã— 100%
                            if (totalAccumulatedPremium > 0) {
                                const profit = currentTotalBenefit - prevTotalBenefit;
                                yieldRate = ((profit / totalAccumulatedPremium) * 100).toFixed(2) + "%";
                            }
                        }
                    }
                    prevTotalBenefit = totalBenefit;

                    // æ•´ç†ç»“æœï¼ˆæ‰€æœ‰æ•°å€¼å–æ•´ï¼‰
                    results.push({
                        year: year,
                        age: currentAge,
                        yearPremium: Math.round(yearPremium),
                        accumulatedPremium: Math.round(accumulatedPremium),
                        cashValue: cashValue,
                        accumulatedBonus: accumulatedBonus,
                        totalBenefit: totalBenefit,
                        yieldRate: yieldRate
                    });
                }

                if (results.length === 0) {
                    alert("æœªæŸ¥æ‰¾åˆ°æ•°æ®ï¼Œè¯·é‡æ–°è¾“å…¥å‚æ•°");
                }

                return results;
            }
        }

        // 3. DOMå…ƒç´ è·å–ä¸åˆå§‹åŒ–
        const ageSlider = document.getElementById('age');
        const ageValue = document.getElementById('ageValue');
        const genderButtons = document.querySelectorAll('.gender-button');
        const paymentButtons = document.querySelectorAll('.payment-button');
        const premiumButtons = document.querySelectorAll('.premium-button');
        const customPremium = document.getElementById('customPremium');
        const calculateBtn = document.getElementById('calculateBtn');
        const resultSection = document.getElementById('resultSection');
        const resultBody = document.getElementById('resultBody');
        const loading = document.getElementById('loading');
        const exportBtn = document.getElementById('exportBtn');
        const shareBtn = document.getElementById('shareBtn');

        // å½“å‰é€‰æ‹©çš„å‚æ•°
        let currentAge = parseInt(ageSlider.value);
        let currentGender = 'female';
        let currentPaymentYears = 5;
        let currentAnnualPremium = 100000;

        // åˆå§‹åŒ–è®¡ç®—å™¨
        const calculator = new InsuranceCalculator();

        // 4. äº‹ä»¶ç›‘å¬å™¨ï¼šå‚æ•°é€‰æ‹©
        // å¹´é¾„æ»‘å—
        ageSlider.addEventListener('input', function() {
            currentAge = parseInt(this.value);
            ageValue.textContent = currentAge + 'å²';
        });

        // æ€§åˆ«é€‰æ‹©
        genderButtons.forEach(button => {
            button.addEventListener('click', function() {
                genderButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                currentGender = this.dataset.gender;
            });
        });

        // äº¤è´¹æœŸé—´é€‰æ‹©
        paymentButtons.forEach(button => {
            button.addEventListener('click', function() {
                paymentButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                currentPaymentYears = parseInt(this.dataset.payment);
            });
        });

        // ä¿è´¹é€‰æ‹©
        premiumButtons.forEach(button => {
            button.addEventListener('click', function() {
                premiumButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                currentAnnualPremium = parseInt(this.dataset.premium);
                customPremium.value = '';
            });
        });

        // è‡ªå®šä¹‰ä¿è´¹è¾“å…¥
        customPremium.addEventListener('input', function() {
            if (this.value && !isNaN(this.value) && this.value > 0) {
                premiumButtons.forEach(btn => btn.classList.remove('active'));
                currentAnnualPremium = parseInt(this.value);
            }
        });

        // 5. è®¡ç®—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        calculateBtn.addEventListener('click', async function() {
            loading.style.display = 'block';
            resultSection.classList.add('hidden');
            resultBody.innerHTML = '';

            if (!insuranceDatabase) {
                insuranceDatabase = await loadInsuranceData();
                if (!insuranceDatabase) {
                    loading.style.display = 'none';
                    return;
                }
            }

            setTimeout(() => {
                // ä¿®æ”¹è¿™é‡Œï¼šæ˜¾ç¤º50å¹´æ•°æ®è€Œä¸æ˜¯30å¹´
                const results = calculator.calculateFromRealData(
                    currentAge,
                    currentPaymentYears,
                    currentAnnualPremium,
                    50  // æ”¹ä¸º50å¹´
                );

                if (results.length > 0) {
                    displayResults(results);
                }

                loading.style.display = 'none';
                resultSection.classList.remove('hidden');
            }, 500);
        });

        // 6. æ˜¾ç¤ºç»“æœåˆ°è¡¨æ ¼
        function displayResults(results) {
            resultBody.innerHTML = '';
            
            // æ ¼å¼åŒ–å‡½æ•°ï¼šå¤„ç†æ•°å­—å’Œå ä½ç¬¦
            const formatValue = (value) => {
                if (value === "-" || value === null || value === undefined) {
                    return "-";
                }
                if (typeof value === 'number') {
                    return value.toLocaleString('zh-CN');
                }
                return value;
            };

            results.forEach(item => {
                // åˆ¤æ–­æ˜¯å¦ä¸ºå ä½ç¬¦è¡Œ
                const isPlaceholder = item.cashValue === "-";
                const rowClass = isPlaceholder ? 'style="background-color: #f9f9f9; color: #999; font-style: italic;"' : '';
        
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border border-gray-300 text-center">${item.year}</td>
                    <td class="border border-gray-300 text-center">${item.age}</td>
                    <td class="border border-gray-300 text-right">${formatValue(item.yearPremium)}</td>
                    <td class="border border-gray-300 text-right">${formatValue(item.accumulatedPremium)}</td>
                    <td class="border border-gray-300 text-right">${formatValue(item.cashValue)}</td>
                    <td class="border border-gray-300 text-right">${formatValue(item.accumulatedBonus)}</td>
                    <td class="border border-gray-300 text-right">${formatValue(item.totalBenefit)}</td>
                    <td class="border border-gray-300 text-right">${formatValue(item.yieldRate)}</td>
                `;
        
                // å¦‚æœè¯¥è¡Œæ˜¯å ä½ç¬¦ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
                if (isPlaceholder) {
                    row.style.backgroundColor = '#f9f9f9';
                    row.style.color = '#999';
                    row.style.fontStyle = 'italic';
                }
        
                resultBody.appendChild(row);
            });
    
            // æ·»åŠ è¯´æ˜æ–‡å­—
            const note = document.createElement('div');
            note.className = 'data-source';
            note.innerHTML = 'âœ… æ•°æ®æ¥æºï¼šå…¨å¹´é¾„æ®µåˆå¹¶æ•°æ®.json<br>' +
                             '<span style="color: #999; font-style: italic;">* çº¢åˆ©ä¸ºé¢„è®¡æ•°æ®ï¼Œå®é™…é‡‘é¢ä»¥ä¿é™©å…¬å¸å…¬å¸ƒä¸ºå‡†</span>';
            resultSection.appendChild(note);
        }

        // 7. åˆ†äº«åŠŸèƒ½
        function generateShareableLink() {
            const params = new URLSearchParams({
                age: currentAge,
                gender: currentGender,
                paymentYears: currentPaymentYears,
                annualPremium: currentAnnualPremium
            });
            
            const currentUrl = window.location.href.split('?')[0];
            const shareUrl = `${currentUrl}?${params.toString()}`;
            
            showShareModal(shareUrl);
        }

        function showShareModal(shareUrl) {
            const modalHtml = `
                <div id="shareModal">
                    <div class="share-modal-content">
                        <h3 style="font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center;">åˆ†äº«ä¿é™©è®¡åˆ’ä¹¦</h3>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; font-size: 14px; margin-bottom: 5px; font-weight: 500;">åˆ†äº«é“¾æ¥ï¼š</label>
                            <div style="display: flex;">
                                <input type="text" id="shareUrl" value="${shareUrl}" class="share-url-input" readonly>
                                <button onclick="copyShareUrl()" class="copy-btn">å¤åˆ¶</button>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin: 20px 0;">
                            <div class="qrcode-container">
                                <div style="text-align: center;">
                                    <div style="font-size: 48px;">ğŸ“±</div>
                                    <div style="font-size: 10px; margin-top: 5px;">æ‰«æäºŒç»´ç </div>
                                    <div style="font-size: 8px; color: #666;">${shareUrl.substring(0, 20)}...</div>
                                </div>
                            </div>
                            <p style="font-size: 12px; color: #666;">å¾®ä¿¡æ‰«ä¸€æ‰«æ‰“å¼€</p>
                        </div>
                        
                        <div class="modal-buttons">
                            <button onclick="shareToWechat()" class="modal-btn primary">å¾®ä¿¡åˆ†äº«</button>
                            <button onclick="closeShareModal()" class="modal-btn secondary">å…³é—­</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function copyShareUrl() {
            const shareUrlInput = document.getElementById('shareUrl');
            shareUrlInput.select();
            document.execCommand('copy');
            alert('âœ… é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }

        function shareToWechat() {
            alert('ğŸ“± è¯·å°†å¤åˆ¶çš„é“¾æ¥å‘é€åˆ°å¾®ä¿¡èŠå¤©çª—å£');
        }

        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            if (modal) modal.remove();
        }

        // åˆ†äº«æŒ‰é’®äº‹ä»¶
        shareBtn.addEventListener('click', function() {
            generateShareableLink();
        });

        // 8. å¯¼å‡ºåŠŸèƒ½
        exportBtn.addEventListener('click', function() {
            alert('å¯¼å‡ºExceléœ€é›†æˆSheetJSåº“ï¼Œå¯å‚è€ƒå®˜æ–¹æ–‡æ¡£æ·»åŠ åŠŸèƒ½');
        });

        // 9. URLå‚æ•°è§£æåŠŸèƒ½
        function parseUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.has('age')) {
                currentAge = parseInt(urlParams.get('age')) || 50;
                currentGender = urlParams.get('gender') || 'female';
                currentPaymentYears = parseInt(urlParams.get('paymentYears')) || 5;
                currentAnnualPremium = parseInt(urlParams.get('annualPremium')) || 100000;
                
                document.getElementById('age').value = currentAge;
                document.getElementById('ageValue').textContent = currentAge + 'å²';
                
                // è®¾ç½®é€‰ä¸­çŠ¶æ€
                setActiveButton('[data-gender="' + currentGender + '"]', 'gender');
                setActiveButton('[data-payment="' + currentPaymentYears + '"]', 'payment');
                setActiveButton('[data-premium="' + currentAnnualPremium + '"]', 'premium');
                
                // è‡ªåŠ¨è®¡ç®—
                setTimeout(() => {
                    calculateBenefits();
                }, 1000);
            }
        }

        function setActiveButton(selector, type) {
            const buttons = document.querySelectorAll('.' + type + '-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            const targetBtn = document.querySelector(selector);
            if (targetBtn) targetBtn.classList.add('active');
        }

        // 10. é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹é¢„åŠ è½½çœŸå®æ•°æ®...");
            insuranceDatabase = await loadInsuranceData();
            parseUrlParameters(); // è§£æURLå‚æ•°
        });

        // 11. è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—åˆ©ç›Š
        async function calculateBenefits() {
            loading.style.display = 'block';
            resultSection.classList.add('hidden');
            resultBody.innerHTML = '';

            if (!insuranceDatabase) {
                insuranceDatabase = await loadInsuranceData();
                if (!insuranceDatabase) {
                    loading.style.display = 'none';
                    return;
                }
            }

            setTimeout(() => {
                // ä¿®æ”¹è¿™é‡Œï¼šæ˜¾ç¤º50å¹´æ•°æ®
                const results = calculator.calculateFromRealData(
                    currentAge, 
                    currentPaymentYears, 
                    currentAnnualPremium,
                    50  // æ”¹ä¸º50å¹´
                );
        
                if (results.length > 0) {
                    displayResults(results);
                }
        
                loading.style.display = 'none';
                resultSection.classList.remove('hidden');
            }, 500);
        }
    </script>
</body>
</html>